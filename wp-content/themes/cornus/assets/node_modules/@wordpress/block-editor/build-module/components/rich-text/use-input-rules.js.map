{"version":3,"names":["useRef","useRefEffect","insert","toHTMLString","getBlockTransforms","findTransform","useDispatch","store","blockEditorStore","preventEventDiscovery","retrieveSelectedAttribute","START_OF_SELECTED_AREA","findSelection","blocks","i","length","attributeKey","attributes","toString","replace","clientId","nestedSelection","innerBlocks","useInputRules","props","__unstableMarkLastChangeAsPersistent","__unstableMarkAutomaticChange","propsRef","current","element","inputRule","getValue","onReplace","selectionChange","value","start","text","characterBefore","slice","trimmedTextBefore","trim","prefixTransforms","filter","type","transformation","prefix","content","block","transform","onInput","event","inputType","onChange","__unstableAllowPrefixTransformations","formatTypes","transformed","reduce","accumlator","__unstableInputRule","activeFormats","addEventListener","removeEventListener"],"sources":["@wordpress/block-editor/src/components/rich-text/use-input-rules.js"],"sourcesContent":["/**\n * WordPress dependencies\n */\nimport { useRef } from '@wordpress/element';\nimport { useRefEffect } from '@wordpress/compose';\nimport { insert, toHTMLString } from '@wordpress/rich-text';\nimport { getBlockTransforms, findTransform } from '@wordpress/blocks';\nimport { useDispatch } from '@wordpress/data';\n\n/**\n * Internal dependencies\n */\nimport { store as blockEditorStore } from '../../store';\nimport { preventEventDiscovery } from './prevent-event-discovery';\nimport {\n\tretrieveSelectedAttribute,\n\tSTART_OF_SELECTED_AREA,\n} from '../../utils/selection';\n\nfunction findSelection( blocks ) {\n\tlet i = blocks.length;\n\n\twhile ( i-- ) {\n\t\tconst attributeKey = retrieveSelectedAttribute(\n\t\t\tblocks[ i ].attributes\n\t\t);\n\n\t\tif ( attributeKey ) {\n\t\t\tblocks[ i ].attributes[ attributeKey ] = blocks[ i ].attributes[\n\t\t\t\tattributeKey\n\t\t\t]\n\t\t\t\t// To do: refactor this to use rich text's selection instead, so\n\t\t\t\t// we no longer have to use on this hack inserting a special\n\t\t\t\t// character.\n\t\t\t\t.toString()\n\t\t\t\t.replace( START_OF_SELECTED_AREA, '' );\n\t\t\treturn [ blocks[ i ].clientId, attributeKey, 0, 0 ];\n\t\t}\n\n\t\tconst nestedSelection = findSelection( blocks[ i ].innerBlocks );\n\n\t\tif ( nestedSelection ) {\n\t\t\treturn nestedSelection;\n\t\t}\n\t}\n\n\treturn [];\n}\n\nexport function useInputRules( props ) {\n\tconst {\n\t\t__unstableMarkLastChangeAsPersistent,\n\t\t__unstableMarkAutomaticChange,\n\t} = useDispatch( blockEditorStore );\n\tconst propsRef = useRef( props );\n\tpropsRef.current = props;\n\treturn useRefEffect( ( element ) => {\n\t\tfunction inputRule() {\n\t\t\tconst { getValue, onReplace, selectionChange } = propsRef.current;\n\n\t\t\tif ( ! onReplace ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// We must use getValue() here because value may be update\n\t\t\t// asynchronously.\n\t\t\tconst value = getValue();\n\t\t\tconst { start, text } = value;\n\t\t\tconst characterBefore = text.slice( start - 1, start );\n\n\t\t\t// The character right before the caret must be a plain space.\n\t\t\tif ( characterBefore !== ' ' ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst trimmedTextBefore = text.slice( 0, start ).trim();\n\t\t\tconst prefixTransforms = getBlockTransforms( 'from' ).filter(\n\t\t\t\t( { type } ) => type === 'prefix'\n\t\t\t);\n\t\t\tconst transformation = findTransform(\n\t\t\t\tprefixTransforms,\n\t\t\t\t( { prefix } ) => {\n\t\t\t\t\treturn trimmedTextBefore === prefix;\n\t\t\t\t}\n\t\t\t);\n\n\t\t\tif ( ! transformation ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst content = toHTMLString( {\n\t\t\t\tvalue: insert( value, START_OF_SELECTED_AREA, 0, start ),\n\t\t\t} );\n\t\t\tconst block = transformation.transform( content );\n\n\t\t\tselectionChange( ...findSelection( [ block ] ) );\n\t\t\tonReplace( [ block ] );\n\t\t\t__unstableMarkAutomaticChange();\n\n\t\t\treturn true;\n\t\t}\n\n\t\tfunction onInput( event ) {\n\t\t\tconst { inputType, type } = event;\n\t\t\tconst {\n\t\t\t\tgetValue,\n\t\t\t\tonChange,\n\t\t\t\t__unstableAllowPrefixTransformations,\n\t\t\t\tformatTypes,\n\t\t\t} = propsRef.current;\n\n\t\t\t// Only run input rules when inserting text.\n\t\t\tif ( inputType !== 'insertText' && type !== 'compositionend' ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif ( __unstableAllowPrefixTransformations && inputRule() ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst value = getValue();\n\t\t\tconst transformed = formatTypes.reduce(\n\t\t\t\t( accumlator, { __unstableInputRule } ) => {\n\t\t\t\t\tif ( __unstableInputRule ) {\n\t\t\t\t\t\taccumlator = __unstableInputRule( accumlator );\n\t\t\t\t\t}\n\n\t\t\t\t\treturn accumlator;\n\t\t\t\t},\n\t\t\t\tpreventEventDiscovery( value )\n\t\t\t);\n\n\t\t\tif ( transformed !== value ) {\n\t\t\t\t__unstableMarkLastChangeAsPersistent();\n\t\t\t\tonChange( {\n\t\t\t\t\t...transformed,\n\t\t\t\t\tactiveFormats: value.activeFormats,\n\t\t\t\t} );\n\t\t\t\t__unstableMarkAutomaticChange();\n\t\t\t}\n\t\t}\n\n\t\telement.addEventListener( 'input', onInput );\n\t\telement.addEventListener( 'compositionend', onInput );\n\t\treturn () => {\n\t\t\telement.removeEventListener( 'input', onInput );\n\t\t\telement.removeEventListener( 'compositionend', onInput );\n\t\t};\n\t}, [] );\n}\n"],"mappings":"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"}