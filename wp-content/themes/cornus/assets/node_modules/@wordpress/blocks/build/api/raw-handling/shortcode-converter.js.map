{"version":3,"names":["_shortcode","require","_factory","_registration","_getBlockAttributes","_applyBuiltInValidationFixes","castArray","maybeArray","Array","isArray","segmentHTMLToShortcodeBlock","HTML","lastIndex","excludedBlockNames","transformsFrom","getBlockTransforms","transformation","findTransform","transform","indexOf","blockName","type","tag","some","regexp","test","transformTags","transformTag","find","match","previousIndex","next","index","content","length","beforeHTML","substr","afterHTML","shortcode","includes","isMatch","attrs","blocks","concat","map","block","originalContent","applyBuiltInValidationFixes","getBlockType","name","attributes","Object","fromEntries","entries","filter","schema","key","blockType","transformationBlockType","createBlock","getBlockAttributes","_default","exports","default"],"sources":["@wordpress/blocks/src/api/raw-handling/shortcode-converter.js"],"sourcesContent":["/**\n * WordPress dependencies\n */\nimport { regexp, next } from '@wordpress/shortcode';\n\n/**\n * Internal dependencies\n */\nimport { createBlock, getBlockTransforms, findTransform } from '../factory';\nimport { getBlockType } from '../registration';\nimport { getBlockAttributes } from '../parser/get-block-attributes';\nimport { applyBuiltInValidationFixes } from '../parser/apply-built-in-validation-fixes';\n\nconst castArray = ( maybeArray ) =>\n\tArray.isArray( maybeArray ) ? maybeArray : [ maybeArray ];\n\nfunction segmentHTMLToShortcodeBlock(\n\tHTML,\n\tlastIndex = 0,\n\texcludedBlockNames = []\n) {\n\t// Get all matches.\n\tconst transformsFrom = getBlockTransforms( 'from' );\n\n\tconst transformation = findTransform(\n\t\ttransformsFrom,\n\t\t( transform ) =>\n\t\t\texcludedBlockNames.indexOf( transform.blockName ) === -1 &&\n\t\t\ttransform.type === 'shortcode' &&\n\t\t\tcastArray( transform.tag ).some( ( tag ) =>\n\t\t\t\tregexp( tag ).test( HTML )\n\t\t\t)\n\t);\n\n\tif ( ! transformation ) {\n\t\treturn [ HTML ];\n\t}\n\n\tconst transformTags = castArray( transformation.tag );\n\tconst transformTag = transformTags.find( ( tag ) =>\n\t\tregexp( tag ).test( HTML )\n\t);\n\n\tlet match;\n\tconst previousIndex = lastIndex;\n\n\tif ( ( match = next( transformTag, HTML, lastIndex ) ) ) {\n\t\tlastIndex = match.index + match.content.length;\n\t\tconst beforeHTML = HTML.substr( 0, match.index );\n\t\tconst afterHTML = HTML.substr( lastIndex );\n\n\t\t// If the shortcode content does not contain HTML and the shortcode is\n\t\t// not on a new line (or in paragraph from Markdown converter),\n\t\t// consider the shortcode as inline text, and thus skip conversion for\n\t\t// this segment.\n\t\tif (\n\t\t\t! match.shortcode.content?.includes( '<' ) &&\n\t\t\t! (\n\t\t\t\t/(\\n|<p>)\\s*$/.test( beforeHTML ) &&\n\t\t\t\t/^\\s*(\\n|<\\/p>)/.test( afterHTML )\n\t\t\t)\n\t\t) {\n\t\t\treturn segmentHTMLToShortcodeBlock( HTML, lastIndex );\n\t\t}\n\n\t\t// If a transformation's `isMatch` predicate fails for the inbound\n\t\t// shortcode, try again by excluding the current block type.\n\t\t//\n\t\t// This is the only call to `segmentHTMLToShortcodeBlock` that should\n\t\t// ever carry over `excludedBlockNames`. Other calls in the module\n\t\t// should skip that argument as a way to reset the exclusion state, so\n\t\t// that one `isMatch` fail in an HTML fragment doesn't prevent any\n\t\t// valid matches in subsequent fragments.\n\t\tif (\n\t\t\ttransformation.isMatch &&\n\t\t\t! transformation.isMatch( match.shortcode.attrs )\n\t\t) {\n\t\t\treturn segmentHTMLToShortcodeBlock( HTML, previousIndex, [\n\t\t\t\t...excludedBlockNames,\n\t\t\t\ttransformation.blockName,\n\t\t\t] );\n\t\t}\n\n\t\tlet blocks = [];\n\t\tif ( typeof transformation.transform === 'function' ) {\n\t\t\t// Passing all of `match` as second argument is intentionally broad\n\t\t\t// but shouldn't be too relied upon.\n\t\t\t//\n\t\t\t// See: https://github.com/WordPress/gutenberg/pull/3610#discussion_r152546926\n\t\t\tblocks = [].concat(\n\t\t\t\ttransformation.transform( match.shortcode.attrs, match )\n\t\t\t);\n\n\t\t\t// Applying the built-in fixes can enhance the attributes with missing content like \"className\".\n\t\t\tblocks = blocks.map( ( block ) => {\n\t\t\t\tblock.originalContent = match.shortcode.content;\n\t\t\t\treturn applyBuiltInValidationFixes(\n\t\t\t\t\tblock,\n\t\t\t\t\tgetBlockType( block.name )\n\t\t\t\t);\n\t\t\t} );\n\t\t} else {\n\t\t\tconst attributes = Object.fromEntries(\n\t\t\t\tObject.entries( transformation.attributes )\n\t\t\t\t\t.filter( ( [ , schema ] ) => schema.shortcode )\n\t\t\t\t\t// Passing all of `match` as second argument is intentionally broad\n\t\t\t\t\t// but shouldn't be too relied upon.\n\t\t\t\t\t//\n\t\t\t\t\t// See: https://github.com/WordPress/gutenberg/pull/3610#discussion_r152546926\n\t\t\t\t\t.map( ( [ key, schema ] ) => [\n\t\t\t\t\t\tkey,\n\t\t\t\t\t\tschema.shortcode( match.shortcode.attrs, match ),\n\t\t\t\t\t] )\n\t\t\t);\n\n\t\t\tconst blockType = getBlockType( transformation.blockName );\n\t\t\tif ( ! blockType ) {\n\t\t\t\treturn [ HTML ];\n\t\t\t}\n\n\t\t\tconst transformationBlockType = {\n\t\t\t\t...blockType,\n\t\t\t\tattributes: transformation.attributes,\n\t\t\t};\n\n\t\t\tlet block = createBlock(\n\t\t\t\ttransformation.blockName,\n\t\t\t\tgetBlockAttributes(\n\t\t\t\t\ttransformationBlockType,\n\t\t\t\t\tmatch.shortcode.content,\n\t\t\t\t\tattributes\n\t\t\t\t)\n\t\t\t);\n\n\t\t\t// Applying the built-in fixes can enhance the attributes with missing content like \"className\".\n\t\t\tblock.originalContent = match.shortcode.content;\n\t\t\tblock = applyBuiltInValidationFixes(\n\t\t\t\tblock,\n\t\t\t\ttransformationBlockType\n\t\t\t);\n\n\t\t\tblocks = [ block ];\n\t\t}\n\n\t\treturn [\n\t\t\t...segmentHTMLToShortcodeBlock( beforeHTML ),\n\t\t\t...blocks,\n\t\t\t...segmentHTMLToShortcodeBlock( afterHTML ),\n\t\t];\n\t}\n\n\treturn [ HTML ];\n}\n\nexport default segmentHTMLToShortcodeBlock;\n"],"mappings":"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"}