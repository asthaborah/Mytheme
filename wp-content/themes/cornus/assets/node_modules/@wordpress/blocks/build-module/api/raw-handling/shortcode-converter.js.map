{"version":3,"names":["regexp","next","createBlock","getBlockTransforms","findTransform","getBlockType","getBlockAttributes","applyBuiltInValidationFixes","castArray","maybeArray","Array","isArray","segmentHTMLToShortcodeBlock","HTML","lastIndex","excludedBlockNames","transformsFrom","transformation","transform","indexOf","blockName","type","tag","some","test","transformTags","transformTag","find","match","previousIndex","index","content","length","beforeHTML","substr","afterHTML","shortcode","includes","isMatch","attrs","blocks","concat","map","block","originalContent","name","attributes","Object","fromEntries","entries","filter","schema","key","blockType","transformationBlockType"],"sources":["@wordpress/blocks/src/api/raw-handling/shortcode-converter.js"],"sourcesContent":["/**\n * WordPress dependencies\n */\nimport { regexp, next } from '@wordpress/shortcode';\n\n/**\n * Internal dependencies\n */\nimport { createBlock, getBlockTransforms, findTransform } from '../factory';\nimport { getBlockType } from '../registration';\nimport { getBlockAttributes } from '../parser/get-block-attributes';\nimport { applyBuiltInValidationFixes } from '../parser/apply-built-in-validation-fixes';\n\nconst castArray = ( maybeArray ) =>\n\tArray.isArray( maybeArray ) ? maybeArray : [ maybeArray ];\n\nfunction segmentHTMLToShortcodeBlock(\n\tHTML,\n\tlastIndex = 0,\n\texcludedBlockNames = []\n) {\n\t// Get all matches.\n\tconst transformsFrom = getBlockTransforms( 'from' );\n\n\tconst transformation = findTransform(\n\t\ttransformsFrom,\n\t\t( transform ) =>\n\t\t\texcludedBlockNames.indexOf( transform.blockName ) === -1 &&\n\t\t\ttransform.type === 'shortcode' &&\n\t\t\tcastArray( transform.tag ).some( ( tag ) =>\n\t\t\t\tregexp( tag ).test( HTML )\n\t\t\t)\n\t);\n\n\tif ( ! transformation ) {\n\t\treturn [ HTML ];\n\t}\n\n\tconst transformTags = castArray( transformation.tag );\n\tconst transformTag = transformTags.find( ( tag ) =>\n\t\tregexp( tag ).test( HTML )\n\t);\n\n\tlet match;\n\tconst previousIndex = lastIndex;\n\n\tif ( ( match = next( transformTag, HTML, lastIndex ) ) ) {\n\t\tlastIndex = match.index + match.content.length;\n\t\tconst beforeHTML = HTML.substr( 0, match.index );\n\t\tconst afterHTML = HTML.substr( lastIndex );\n\n\t\t// If the shortcode content does not contain HTML and the shortcode is\n\t\t// not on a new line (or in paragraph from Markdown converter),\n\t\t// consider the shortcode as inline text, and thus skip conversion for\n\t\t// this segment.\n\t\tif (\n\t\t\t! match.shortcode.content?.includes( '<' ) &&\n\t\t\t! (\n\t\t\t\t/(\\n|<p>)\\s*$/.test( beforeHTML ) &&\n\t\t\t\t/^\\s*(\\n|<\\/p>)/.test( afterHTML )\n\t\t\t)\n\t\t) {\n\t\t\treturn segmentHTMLToShortcodeBlock( HTML, lastIndex );\n\t\t}\n\n\t\t// If a transformation's `isMatch` predicate fails for the inbound\n\t\t// shortcode, try again by excluding the current block type.\n\t\t//\n\t\t// This is the only call to `segmentHTMLToShortcodeBlock` that should\n\t\t// ever carry over `excludedBlockNames`. Other calls in the module\n\t\t// should skip that argument as a way to reset the exclusion state, so\n\t\t// that one `isMatch` fail in an HTML fragment doesn't prevent any\n\t\t// valid matches in subsequent fragments.\n\t\tif (\n\t\t\ttransformation.isMatch &&\n\t\t\t! transformation.isMatch( match.shortcode.attrs )\n\t\t) {\n\t\t\treturn segmentHTMLToShortcodeBlock( HTML, previousIndex, [\n\t\t\t\t...excludedBlockNames,\n\t\t\t\ttransformation.blockName,\n\t\t\t] );\n\t\t}\n\n\t\tlet blocks = [];\n\t\tif ( typeof transformation.transform === 'function' ) {\n\t\t\t// Passing all of `match` as second argument is intentionally broad\n\t\t\t// but shouldn't be too relied upon.\n\t\t\t//\n\t\t\t// See: https://github.com/WordPress/gutenberg/pull/3610#discussion_r152546926\n\t\t\tblocks = [].concat(\n\t\t\t\ttransformation.transform( match.shortcode.attrs, match )\n\t\t\t);\n\n\t\t\t// Applying the built-in fixes can enhance the attributes with missing content like \"className\".\n\t\t\tblocks = blocks.map( ( block ) => {\n\t\t\t\tblock.originalContent = match.shortcode.content;\n\t\t\t\treturn applyBuiltInValidationFixes(\n\t\t\t\t\tblock,\n\t\t\t\t\tgetBlockType( block.name )\n\t\t\t\t);\n\t\t\t} );\n\t\t} else {\n\t\t\tconst attributes = Object.fromEntries(\n\t\t\t\tObject.entries( transformation.attributes )\n\t\t\t\t\t.filter( ( [ , schema ] ) => schema.shortcode )\n\t\t\t\t\t// Passing all of `match` as second argument is intentionally broad\n\t\t\t\t\t// but shouldn't be too relied upon.\n\t\t\t\t\t//\n\t\t\t\t\t// See: https://github.com/WordPress/gutenberg/pull/3610#discussion_r152546926\n\t\t\t\t\t.map( ( [ key, schema ] ) => [\n\t\t\t\t\t\tkey,\n\t\t\t\t\t\tschema.shortcode( match.shortcode.attrs, match ),\n\t\t\t\t\t] )\n\t\t\t);\n\n\t\t\tconst blockType = getBlockType( transformation.blockName );\n\t\t\tif ( ! blockType ) {\n\t\t\t\treturn [ HTML ];\n\t\t\t}\n\n\t\t\tconst transformationBlockType = {\n\t\t\t\t...blockType,\n\t\t\t\tattributes: transformation.attributes,\n\t\t\t};\n\n\t\t\tlet block = createBlock(\n\t\t\t\ttransformation.blockName,\n\t\t\t\tgetBlockAttributes(\n\t\t\t\t\ttransformationBlockType,\n\t\t\t\t\tmatch.shortcode.content,\n\t\t\t\t\tattributes\n\t\t\t\t)\n\t\t\t);\n\n\t\t\t// Applying the built-in fixes can enhance the attributes with missing content like \"className\".\n\t\t\tblock.originalContent = match.shortcode.content;\n\t\t\tblock = applyBuiltInValidationFixes(\n\t\t\t\tblock,\n\t\t\t\ttransformationBlockType\n\t\t\t);\n\n\t\t\tblocks = [ block ];\n\t\t}\n\n\t\treturn [\n\t\t\t...segmentHTMLToShortcodeBlock( beforeHTML ),\n\t\t\t...blocks,\n\t\t\t...segmentHTMLToShortcodeBlock( afterHTML ),\n\t\t];\n\t}\n\n\treturn [ HTML ];\n}\n\nexport default segmentHTMLToShortcodeBlock;\n"],"mappings":"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"}